let test_consistent_with_mec () =
  let test_vectors =
    [ ( [| "0";
           "19540886853600136773806888540031779652697522926951761090609474934921975120659";
           "27368034540955591518185075247638312229509481411752400387472688330662143761856"
        |],
        [| "17943489144262435388134690770306545365190731633977654215868012824127324198151";
           "2231754119684576552235072561055622129225837122807214026821170668631716242147";
           "29261523742327067247029179638981197564247814302680832614540814949720900275190"
        |] );
      ( [| "0";
           "27079498335589470388559429012071885383086029562052523482197446658383111072774";
           "42808036164195249275280963312025828986508786508614910971333518929197538998773"
        |],
        [| "24183560910605453752776639786227559025963231226657372504816371318001117542043";
           "35029299207990307567943227124638286593042324757574009533577874051172424731112";
           "5149101922766693039542544793826724317233738847055587332789635646881987279038"
        |] );
      ( [| "0";
           "2280773603130921897588628948561054337050485605305725986334019017364524534576";
           "49742584797721038216392695876666332237687899609664289853866233942594829409245"
        |],
        [| "35816535646044617407808534693371034506444808081714503610242949185965092595026";
           "5363956515446161539161780954417765912037041392866393510569016892172498529944";
           "32254025883747625406036521648265940411925032697688307242655649591762898002497"
        |] );
      ( [| "0";
           "47345255170739768354940339244069904962490289137071838723660628082786560244227";
           "12508134994244913485311518548620293355291296251148491744230743543606532994206"
        |],
        [| "9091234811689308509102172807464454311569090414440587970689563456088495182507";
           "14174922240502925080674757917320110469967806338655989126339180218846318661667";
           "36498938306563858591852167046454653325721089316694704626906932069658540502064"
        |] );
      ( [| "0";
           "22266149478348354835731057366322705807112053199389518651299197937563769914341";
           "46391019025260596444368872653036215340017923491388854958773789052412558961328"
        |],
        [| "38438670864363407523537730683343143710087993977705604857656216937687834130603";
           "16221205305575053191586076875532883527874413609923551381849833895354625853752";
           "21204380361849499989864581430501306982675221862819264096834120630459940923576"
        |] ) ]
  in
  List.iter
    (fun (inputs, expected_output) ->
      let inputs = Array.map Bls12_381.Fr.of_string inputs in
      let expected_output = Array.map Bls12_381.Fr.of_string expected_output in
      Bls12_381_hash.Poseidon128.constants_init
        Poseidon128_ark.v
        Poseidon128_mds.v ;
      let ctxt =
        Bls12_381_hash.Poseidon128.init inputs.(0) inputs.(1) inputs.(2)
      in
      let () = Bls12_381_hash.Poseidon128.apply_permutation ctxt in
      let a, b, c = Bls12_381_hash.Poseidon128.get ctxt in
      let output = [| a; b; c |] in
      Array.iter2
        (fun a b ->
          if not (Bls12_381.Fr.eq a b) then
            Alcotest.failf
              "Expected output is %s, computed %s\n"
              (Bls12_381.Fr.to_string a)
              (Bls12_381.Fr.to_string b))
        expected_output
        output)
    test_vectors

let () =
  let open Alcotest in
  run
    "Poseidon128"
    [ ( "Consistency with MEC",
        [test_case "vectors" `Quick test_consistent_with_mec] ) ]
